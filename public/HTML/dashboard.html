<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> B'Drums - Dashboard </title>
    <link rel="stylesheet" href="../CSS/dashboard.css">

    <link rel="icon" href="../IMG/logo.png" type="image/png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&family=Special+Gothic+Expanded+One&family=Titan+One&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>


    <div class="container">

        <div class="bt-voltar">
            <a href="../BobIA/indexIA.html">
                <img src="../IMG/seta back.png" alt="">
                <u> Voltar </u>
            </a>
        </div>

        <img src="../IMG/logo.png" alt="">
        <h1> DASHBOARD</h1>
        <h3>Dados do Quiz e de Usuarios que acessaram o site </h3>

        <div class="container-indicadores">

            <div class="kpis">
                <div class="kpi">
                    <span id="media_sim"></span>
                </div>

                <div class="kpi">
                    <span id="media_nao"></span>
                </div>

                <div class="kpi">
                    <span id="taxa_de_participacao"></span>
                </div>
            </div>

            <div class="graficos">
                <div class="grafico">
                    <canvas id="myChart1"></canvas>
                </div>


                <div class="grafico">
                    <canvas id="myChart2"></canvas>
                </div>
            </div>

        </div>

    </div>
</body>

<script>

    var acertos1 = 0;
    var erros1 = 0;
    var acertos2 = 0;
    var erros2 = 0;


    function plotarGrafico() {
        const label_quiz = ['acertos', 'erros'];

        // QUIS 1


        const data_quiz1 = {
            labels: label_quiz,
            datasets: [{
                label: '',
                data: [acertos1, erros1],
                backgroundColor: ['#4169E1', '#F44336'],
                borderWidth: 1
            }]
        };

        const config_quiz1 = {
            type: 'pie',
            data: data_quiz1,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '1° QUIS'
                    }
                }
            }
        };


        // QUIS 2

        const data_quiz2 = {
            labels: label_quiz,
            datasets: [{
                label: '',
                data: [acertos2, erros2],
                backgroundColor: ['#4169E1', '#F44336'],
                borderWidth: 1
            }]
        };

        const config_quiz2 = {
            type: 'pie',
            data: data_quiz2,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '2° QUIS'
                    }
                }
            }
        };

        const ctx1 = document.getElementById('myChart1');
        const ctx2 = document.getElementById('myChart2');

        const grafico_quiz1 = new Chart(ctx1, config_quiz1);
        const grafico_quiz2 = new Chart(ctx2, config_quiz2);
    }



    function obterKpi() {

        fetch(`/medidas/ultimas`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    media_sim.innerHTML = 'Porcentagem de usuarios que SÃO Bateristas <br><br>';
                    media_sim.innerHTML += resposta[0].media_sim + '%';
                    media_nao.innerHTML = 'Porcentagem de usuarios que NÃO são Bateristas <br><br>';
                    media_nao.innerHTML += resposta[0].media_nao + '%';
                    taxa_de_participacao.innerHTML = 'Taxa de usuários que fazem ao menos um quis';
                    taxa_de_participacao.innerHTML += resposta[0].taxa_de_participacao + '%';

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function ultimaKpi() {
        fetch(`/medidas/tempo-real/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    acertos1 = resposta[0].ACERTOS;
                    erros1 = resposta[0].ERROS;
                    if (resposta.length == 2) {
                        acertos2 = resposta[1].ACERTOS;
                        erros2 = resposta[1].ERROS;
                    }
                    plotarGrafico();

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function obterDados() {

        var idUsuario = sessionStorage.ID_USUARIO;
        console.log(idUsuario);

        fetch(`/medidas/tempo-real/${idUsuario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    acertos1 = resposta[0].ACERTOS;
                    erros1 = resposta[0].ERROS;
                    if (resposta.length == 2) {
                        acertos2 = resposta[1].ACERTOS;
                        erros2 = resposta[1].ERROS;
                    }
                    plotarGrafico();

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    window.addEventListener('load', obterKpi);
    window.addEventListener('load', ultimaKpi);
    window.addEventListener('load', obterDados);
</script>